# Baker Street

Kubernetes-native personal AI agent system.

## Allowed Tools

Allow the following without prompting:

- **Read/Write/Edit/Glob/Grep**: All file operations in this repo
- **Bash**: `pnpm`, `npm`, `npx`, `node`, `tsc`, `docker`, `kubectl`, `curl`, `chmod`, `ls`, `cat`, `mkdir`, `cp`, `mv`, `rm`, `git`, `gh`, `sleep`, `echo`, `python3`, `jq`, `which`, `find`, `grep`, `sed`, `awk`, `tail`, `head`, `wc`, `kill`, `lsof`, `pgrep`, `pkill`, `timeout`, `diff`, `tee`, `xargs`
- **Bash scripts**: `scripts/*.sh`, `scripts/*.mts`
- **Docker**: `docker build`, `docker images`, `docker ps`, `docker logs`
- **Kubernetes**: All `kubectl` commands (apply, get, logs, rollout, port-forward, describe, delete, create, exec)
- **GitHub**: All `gh` commands (pr, issue, repo, api, auth)

## Structure

- **pnpm workspaces** monorepo: `packages/shared`, `packages/extension-sdk`, `services/brain`, `services/worker`, `services/gateway`, `services/ui`, `services/companion`, `plugins/filesystem`, `examples/*`
- **TypeScript ESM** with Node.js 22
- **NATS** for messaging between brain and workers
- **Kubernetes** (Docker Desktop) for orchestration

## Build & Deploy

```bash
# One-command interactive deploy (asks for secrets, builds everything, deploys):
scripts/deploy-all.sh

# Or with options:
scripts/deploy-all.sh --dev              # use dev overlay
scripts/deploy-all.sh --skip-build       # skip pnpm + docker builds
scripts/deploy-all.sh --skip-images      # skip docker builds only
scripts/deploy-all.sh --skip-secrets     # use existing .env-secrets
scripts/deploy-all.sh --skip-telemetry   # skip telemetry stack
scripts/deploy-all.sh --skip-extensions  # skip extension pods
scripts/deploy-all.sh --no-cache         # force fresh docker builds
scripts/deploy-all.sh -y                 # non-interactive (use defaults)
scripts/deploy-all.sh --version v1.2.3   # custom version tag

# Individual scripts (called by deploy-all.sh internally):
pnpm install                    # install all workspace deps
pnpm -r build                   # compile TypeScript in all workspaces
scripts/build.sh                # docker build all images (brain, worker, ui, gateway)
scripts/secrets.sh              # create k8s secrets (auto-loads .env-secrets)
scripts/deploy.sh               # kubectl apply all manifests
```

### Windows (PowerShell)

```powershell
# Double-click scripts\deploy.bat, or from PowerShell:
.\scripts\Deploy-BakerStreet.ps1

# With options:
.\scripts\Deploy-BakerStreet.ps1 -SkipTelemetry        # skip telemetry stack
.\scripts\Deploy-BakerStreet.ps1 -SkipBuild             # skip pnpm + docker builds
.\scripts\Deploy-BakerStreet.ps1 -SkipSecrets           # use existing .env-secrets
.\scripts\Deploy-BakerStreet.ps1 -SkipExtensions        # skip extension pods
.\scripts\Deploy-BakerStreet.ps1 -Yes                   # non-interactive
```

Prerequisites: Docker Desktop (with Kubernetes enabled) and WSL2.

## Access

```bash
# With NodePort (no port-forward needed):
open http://localhost:30080

# Fallback (port-forward):
kubectl -n bakerst port-forward svc/ui 8080:8080
open http://localhost:8080
```

## Secrets

All secrets live in `.env-secrets` (gitignored). `scripts/secrets.sh` auto-sources this file.

```bash
# .env-secrets contains:
ANTHROPIC_OAUTH_TOKEN     # Claude auth (priority)
VOYAGE_API_KEY            # Voyage AI embeddings
TELEGRAM_BOT_TOKEN        # Telegram gateway adapter
AUTH_TOKEN                # API auth token (auto-generated by secrets.sh if not set)
AGENT_NAME                # AI persona name (default: Baker)
GITHUB_TOKEN              # GitHub extension (personal access token)
OBSIDIAN_VAULT_PATH       # Obsidian extension (host path to vault directory)
```

### Secret Scoping

`scripts/secrets.sh` creates 3+ scoped K8s secrets (instead of one monolithic secret):
- `bakerst-brain-secrets` — ANTHROPIC_*, VOYAGE_API_KEY, AUTH_TOKEN, AGENT_NAME
- `bakerst-worker-secrets` — ANTHROPIC_*, AGENT_NAME
- `bakerst-gateway-secrets` — TELEGRAM_*, DISCORD_*, AUTH_TOKEN
- `bakerst-github-secrets` — GITHUB_TOKEN (created only if token is set)

### AUTH_TOKEN

`AUTH_TOKEN` is a 32-byte hex token auto-generated by `scripts/secrets.sh` on first run and persisted to `.env-secrets`. It protects the Brain API:
- Brain API requires `Authorization: Bearer <token>` on all routes except `/ping`
- Gateway includes the token automatically when calling Brain
- The UI login page prompts for the token; stored in localStorage
- If `AUTH_TOKEN` env is not set, brain runs in dev mode (logs warning, allows all requests)

## Telemetry (Optional)

Telemetry (OTel Collector, Tempo, Loki, Grafana, Prometheus, kube-state-metrics) is **optional** and deployed to a separate `bakerst-telemetry` namespace. The deploy script asks whether to install it.

- `--skip-telemetry` flag skips telemetry entirely
- Without the flag, `deploy-all.sh` prompts interactively (defaults to no)
- Two Prometheus modes:
  - **Local**: deploys Prometheus + kube-state-metrics in `bakerst-telemetry`
  - **External**: pushes metrics via OTel remote-write to an external Prometheus URL; Grafana queries it directly
- Telemetry manifests live in `k8s/telemetry/` (uses Kustomize namespace transformer)
- App services send OTLP to `otel-collector.bakerst-telemetry.svc.cluster.local:4318`
- `DEPLOY_TELEMETRY=true scripts/deploy.sh` enables telemetry in the standalone script

## Key Patterns

- Auth: `ANTHROPIC_OAUTH_TOKEN` (priority) or `ANTHROPIC_API_KEY` (fallback)
- NATS subjects defined in `packages/shared/src/subjects.ts`
- Message types defined in `packages/shared/src/types.ts`
- Personality files in `operating_system/` mounted as ConfigMap
- Plugin system: `plugins/` dir, registered in `operating_system/PLUGINS.json`
- Extensions: pod-based tool extensions via NATS announce + MCP HTTP (see `docs/extensions.md`)

## Security

- **Network Policies**: `k8s/network-policies.yaml` — default-deny ingress, per-service allow rules
- **Pod Security**: All deployments use `seccompProfile: RuntimeDefault`, `readOnlyRootFilesystem: true`, drop all capabilities, `runAsNonRoot: true`
- **Auth**: Bearer token auth on Brain API (see AUTH_TOKEN above)
- **Extensions**: Network-isolated (brain→extension only, extension→NATS only), but each extension must implement its own input validation, authorization, and output sanitization (see `docs/extensions.md`)
