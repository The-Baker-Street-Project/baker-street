# Phase 1.5: Installer & UX Fixes — Design

**Date:** 2026-03-01
**Issues:** BAK-21, BAK-22, BAK-23, BAK-26

---

## BAK-21: Installer Perplexity Secret Prompt

**Root cause:** Feature secret prompts are appended when the user presses Enter on the Features screen. The Perplexity feature has `secrets: ["PERPLEXITY_API_KEY"]` in the manifest, so it should prompt when enabled. The flow depends on `current_secret_index` not being reset and the `collecting_feature_secrets` flag routing back to Secrets phase correctly.

**Fix:** Verify and test the feature secret collection flow end-to-end. Ensure that enabling Perplexity (or any feature with secrets) correctly appends prompts and the user is asked for them before reaching Confirm. Add integration test covering: enable feature → collect secret → confirm.

**Files:** `tools/installer/src/main.rs` (if fix needed), new test

---

## BAK-22: Auto-Enable Features via FEATURE_* Env Vars

**Problem:** The installer deploys extension pods but never sets `FEATURE_*` env vars on the brain deployment. The brain's feature flag system (`packages/shared/src/features.ts`) reads `FEATURE_<SCREAMING_SNAKE>` env vars at startup, falling back to mode defaults. Without explicit env vars, features like `extensions` (default `false`) stay disabled even though their pods are running.

**Fix:** In `build_template_vars()`, for each enabled feature, insert the corresponding `FEATURE_*=true` into the template vars. The brain.yaml template needs a `{{FEATURE_VARS}}` section that expands to additional env entries.

**Feature → Flag mapping:**

| Feature ID | FEATURE_* env var | Target |
|-----------|-------------------|--------|
| telegram | FEATURE_TELEGRAM | brain, gateway |
| discord | FEATURE_DISCORD | brain, gateway |
| github | FEATURE_EXTENSIONS | brain |
| perplexity | FEATURE_EXTENSIONS | brain |
| browser | FEATURE_EXTENSIONS | brain |
| obsidian | FEATURE_EXTENSIONS | brain |
| voyage | FEATURE_MEMORY | brain |

Note: multiple features map to `FEATURE_EXTENSIONS=true` — any extension being enabled implies extensions should be on.

**Approach:** Add a `{{FEATURE_VARS}}` placeholder in brain.yaml that gets replaced with a block of `- name: FEATURE_X\n  value: "true"` entries. The `render()` function in `templates.rs` handles mustache-style replacement. For features that also affect gateway (telegram, discord), do the same in gateway.yaml.

**Files:** `tools/installer/src/main.rs` (build_template_vars), `tools/installer/src/templates/brain.yaml`, `tools/installer/src/templates/gateway.yaml`

---

## BAK-23: UI Conversation Persistence

**Root cause:** Two compounding issues:
1. Chat state lives in `useChat` hook (component-local React state) — destroyed on unmount
2. Sidebar "Chat" link points to `/chat` (no ID) — drops the conversation ID from the URL

When user navigates away, ChatPage unmounts, useChat state is destroyed. When they return via sidebar (`/chat`), no `:id` param means a fresh empty chat.

**Fix (minimal, no context refactor):**
1. In `useChat`, when `conversationId` is set (from backend `done` event), persist it to `sessionStorage` as `bakerst_active_conversation`
2. In `ChatPage`, on mount with no `:id` URL param, check `sessionStorage` for `bakerst_active_conversation` and call `loadConversation(id)` to restore
3. The "New Chat" button clears `sessionStorage` key before resetting state
4. Use `sessionStorage` (not `localStorage`) so it's per-tab and clears on tab close

**Why not lift to context:** That's a larger refactor (new ConversationContext, provider in App.tsx, move all useChat state). The sessionStorage approach solves the immediate issue with minimal changes.

**Files:** `services/ui/src/hooks/useChat.ts`, `services/ui/src/pages/ChatPage.tsx`

---

## BAK-26: SysAdmin Console Auth + Feature Flag Tools

### Auth

Add bearer token auth to the sysadmin API using `AUTH_TOKEN` env var (reused from brain/gateway — BAK-27 will add separate token later).

**Implementation:**
- Auth middleware on Express routes (except `GET /ping`)
- Auth check on WebSocket upgrade (token in `Sec-WebSocket-Protocol` header or query param `?token=`)
- Timing-safe comparison (crypto.timingSafeEqual)
- If `AUTH_TOKEN` is not set, warn and allow all (dev mode, same pattern as brain)
- The embedded terminal UI needs a login prompt — add a simple password input before connecting the WebSocket

**Sysadmin secret mount:** The sysadmin deployment template needs `AUTH_TOKEN` from secrets. Either mount `bakerst-gateway-secrets` (which already has AUTH_TOKEN) or create a dedicated `bakerst-sysadmin-secrets`.

### Feature Flag Tools

Two new tools in `services/sysadmin/src/tools/feature-flags.ts`:

**`get_feature_flags`**
- Reads the brain deployment via K8s API (`readNamespacedDeployment('brain', ns)`)
- Extracts `FEATURE_*` and `BAKERST_MODE` env vars from container spec
- Cross-references with the known flag registry to show defaults vs overrides
- Returns table: flag name, current value, source (env override / mode default)
- Available in: verify, runtime, update

**`set_feature_flag`**
- Input: `flag` (e.g., "telegram"), `enabled` (boolean)
- Converts to env var name (e.g., `FEATURE_TELEGRAM`)
- Checks if the feature requires secrets (from manifest knowledge)
- If secrets needed and not present: uses `ask_user` tool to prompt, then `create_secret`
- Patches brain deployment env vars via K8s API (`patchNamespacedDeployment`)
- Triggers rollout restart
- Available in: runtime, update

**Tool registration:** New `createFeatureFlagTools()` factory, added to `createAllTools()` in `tools/index.ts`. Tool names added to `STATE_TOOLS` in `tool-registry.ts`.

**Files:** `services/sysadmin/src/tools/feature-flags.ts` (new), `services/sysadmin/src/tools/index.ts`, `services/sysadmin/src/tool-registry.ts`, `services/sysadmin/src/api.ts`, `tools/installer/src/templates/sysadmin.yaml`
