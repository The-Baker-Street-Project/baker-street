# Default deny all ingress traffic in the bakerst-telemetry namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny
  namespace: bakerst-telemetry
spec:
  podSelector: {}
  policyTypes:
    - Ingress
---
# OTel Collector: accepts OTLP from brain/worker in bakerst namespace + scrapes from Prometheus
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: otel-collector-policy
  namespace: bakerst-telemetry
spec:
  podSelector:
    matchLabels:
      app: otel-collector
  policyTypes:
    - Ingress
  ingress:
    # OTLP from app services in bakerst namespace
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: bakerst
          podSelector:
            matchLabels:
              app: brain
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: bakerst
          podSelector:
            matchLabels:
              app: worker
      ports:
        - protocol: TCP
          port: 4317
        - protocol: TCP
          port: 4318
    # Prometheus metrics scraping
    - from:
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - protocol: TCP
          port: 8889
---
# Tempo: accepts traces from OTel Collector, queries from Grafana
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tempo-policy
  namespace: bakerst-telemetry
spec:
  podSelector:
    matchLabels:
      app: tempo
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: otel-collector
      ports:
        - protocol: TCP
          port: 4317
    - from:
        - podSelector:
            matchLabels:
              app: grafana
      ports:
        - protocol: TCP
          port: 3200
---
# Loki: accepts logs from OTel Collector, queries from Grafana
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: loki-policy
  namespace: bakerst-telemetry
spec:
  podSelector:
    matchLabels:
      app: loki
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: otel-collector
        - podSelector:
            matchLabels:
              app: grafana
      ports:
        - protocol: TCP
          port: 3100
---
# Grafana: accepts traffic from external (NodePort)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: grafana-policy
  namespace: bakerst-telemetry
spec:
  podSelector:
    matchLabels:
      app: grafana
  policyTypes:
    - Ingress
  ingress:
    - ports:
        - protocol: TCP
          port: 3001
---
# Prometheus: accepts queries from Grafana
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: prometheus-policy
  namespace: bakerst-telemetry
spec:
  podSelector:
    matchLabels:
      app: prometheus
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: grafana
      ports:
        - protocol: TCP
          port: 9090
---
# kube-state-metrics: accepts scrapes from Prometheus
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: kube-state-metrics-policy
  namespace: bakerst-telemetry
spec:
  podSelector:
    matchLabels:
      app: kube-state-metrics
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - protocol: TCP
          port: 8080
